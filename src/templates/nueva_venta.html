{% extends "layout.html" %}

{% block title %}Nueva venta - Taquilla{% endblock %}

{% block customCSS %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="{{ url_for('static', filename ='css/ventas.css') }}">
{% endblock %}

{% block body %}

<div class="venta-header">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h4 mb-1">
          <i class="bi bi-ticket-perforated"></i> Nueva venta
        </h1>
        <p class="mb-0">
          Taquilla · <span class="fw-semibold">{{ current_user.nombre_completo }}</span>
        </p>
      </div>
      <div class="text-end">
        <small class="d-block">Hoy: {{ fecha_hoy }}</small>
        <small class="text-white-50">
          Rol: <span class="fw-semibold">{{ current_user.rol }}</span>
        </small>
      </div>
    </div>
  </div>
</div>

<div class="container pb-4">
  {# Mensajes flash #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'warning' if category=='message' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# Pequeño indicador de pasos #}
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="d-flex flex-wrap gap-3">
        <div class="d-flex align-items-center">
          <span class="step-badge bg-primary text-white">1</span>
          <span class="step-label text-muted">Datos del pasajero</span>
        </div>
        <div class="d-flex align-items-center">
          <span class="step-badge bg-secondary text-white">2</span>
          <span class="step-label text-muted">Seleccionar viaje y asiento</span>
        </div>
        <div class="d-flex align-items-center">
          <span class="step-badge bg-secondary text-white">3</span>
          <span class="step-label text-muted">Confirmar y cobrar</span>
        </div>
      </div>
    </div>
  </div>

  <form method="POST" action="{{ url_for('nueva_venta') }}" class="needs-validation" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="row g-3">
      {# Columna izquierda: datos del pasajero #}
      <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-person-vcard"></i> Datos del pasajero
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="nombre_pasajero" class="form-label">Nombre completo</label>
              <input type="text" class="form-control" id="nombre_pasajero" name="nombre_pasajero"
                     placeholder="Ej: Ana López Martínez" required>
              <div class="invalid-feedback">El nombre del pasajero es obligatorio.</div>
            </div>

            <div class="mb-3">
              <label for="correo_pasajero" class="form-label">Correo electrónico</label>
              <input type="email" class="form-control" id="correo_pasajero" name="correo_pasajero"
                     placeholder="Ej: ana@example.com">
            </div>

            <div class="mb-3">
              <label for="telefono_pasajero" class="form-label">Teléfono</label>
              <input type="tel" class="form-control" id="telefono_pasajero" name="telefono_pasajero"
                     placeholder="Ej: 8123456789">
            </div>

            <div class="mb-3">
              <label for="metodo_pago" class="form-label">Método de pago</label>
              <select class="form-select" id="metodo_pago" name="metodo_pago" required>
                <option value="">Seleccione una opción...</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Transferencia">Transferencia</option>
              </select>
              <div class="invalid-feedback">Seleccione un método de pago.</div>

              <div id="tarjetaModule" style="display:none;">
                <hr>
                <h6><i class="bi bi-credit-card"></i> Pago con tarjeta</h6>

                <div class="mb-3 position-relative">
                  <label class="form-label">Número de tarjeta</label>

                  <i class="bi bi-credit-card-fill text-secondary position-absolute"
                     style="right: 15px; top: 48px; font-size: 1.3rem;"></i>

                  <input type="text"
                         class="form-control"
                         id="card_number"
                         name="tarjeta_numero"
                         maxlength="19"
                         placeholder="XXXX-XXXX-XXXX-XXXX"
                         autocomplete="off">
                </div>

                <div class="row g-3 mb-3">
                  <div class="col-md-4">
                    <label class="form-label">Mes</label>
                    <input type="number" min="1" max="12"
                           class="form-control"
                           id="card_month">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Año</label>
                    <input type="number" min="24" max="40"
                           class="form-control"
                           id="card_year">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">CVV</label>
                    <input type="password" maxlength="4"
                           class="form-control"
                           id="card_cvv">
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Titular</label>
                  <input type="text"
                         class="form-control"
                         id="card_holder"
                         name="tarjeta_nombre">
                </div>

                {# Campo oculto para la fecha de expiración combinada #}
                <input type="hidden" id="tarjeta_expira" name="tarjeta_expira">
              </div>

            </div>
          </div>
        </div>
      </div>

      {# Columna derecha: viaje, asiento y resumen #}
      <div class="col-lg-6">
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-bus-front"></i> Seleccionar viaje
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="viaje" class="form-label">Viaje</label>
              <select class="form-select" id="viaje" name="id_viaje" required>
                <option value="">Seleccione un viaje...</option>
                {% if viajes %}
                  {% for v in viajes %}
                    <option value="{{ v.id_viaje }}">
                      {{ v.salida_label }} · {{ v.origen }} → {{ v.destino }}
                      ({{ v.autobus }} — {{ v.clase_nombre or "Sin clase" }})
                    </option>
                  {% endfor %}
                {% else %}
                  <option value="" disabled>No hay viajes cargados para hoy.</option>
                {% endif %}
              </select>
              <div class="invalid-feedback">Debe seleccionar un viaje para continuar.</div>
            </div>

            <div class="mb-3">
              <label for="numero_asiento" class="form-label">Asiento</label>
              <select class="form-select" id="numero_asiento" name="numero_asiento" required>
                <option value="">Seleccione un asiento...</option>
              </select>
              <div class="invalid-feedback">Seleccione un número de asiento válido.</div>
            </div>
          </div>
        </div>

        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-receipt"></i> Resumen de la venta
            </h5>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-1">
              <span class="text-muted">Pasajero</span>
              <span class="fw-semibold" id="resumen_pasajero">—</span>
            </div>
            <div class="d-flex justify-content-between mb-3">
              <span class="text-muted">Viaje</span>
              <span class="fw-semibold" id="resumen_viaje">—</span>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">
                Cancelar
              </a>
              <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle"></i> Confirmar venta
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form            = document.querySelector('form.needs-validation');
  const nombreInput     = document.getElementById('nombre_pasajero');
  const viajeSelect     = document.getElementById('viaje');
  const resumenPasajero = document.getElementById('resumen_pasajero');
  const resumenViaje    = document.getElementById('resumen_viaje');
  const asientoSelect   = document.getElementById('numero_asiento');

  const metodoPago      = document.getElementById("metodo_pago");
  const tarjetaModule   = document.getElementById("tarjetaModule");
  const cardNumberInput = document.getElementById("card_number");
  const cardMonthInput  = document.getElementById("card_month");
  const cardYearInput   = document.getElementById("card_year");
  const cardCVVInput    = document.getElementById("card_cvv");
  const cardHolderInput = document.getElementById("card_holder");

  // 1) Resumen en vivo
  if (nombreInput && resumenPasajero) {
    nombreInput.addEventListener('input', function () {
      resumenPasajero.textContent = nombreInput.value || '—';
    });
  }

  if (viajeSelect && resumenViaje) {
    viajeSelect.addEventListener('change', function () {
      const opt = viajeSelect.options[viajeSelect.selectedIndex];
      resumenViaje.textContent = (opt && opt.value) ? opt.text : '—';
    });
  }

  // 2) Carga dinámica de asientos
  if (viajeSelect && asientoSelect) {
    viajeSelect.addEventListener('change', function () {
      const idViaje = this.value;

      asientoSelect.innerHTML = '';
      const optDefault = document.createElement('option');
      optDefault.value = '';
      optDefault.textContent = idViaje ? 'Cargando asientos...' : 'Seleccione un asiento...';
      asientoSelect.appendChild(optDefault);

      if (!idViaje) {
        return;
      }

      fetch(`/api/viajes/${idViaje}/asientos`)
        .then(resp => resp.json())
        .then(data => {
          asientoSelect.innerHTML = '';
          const optInicio = document.createElement('option');
          optInicio.value = '';
          optInicio.textContent = 'Seleccione un asiento...';
          asientoSelect.appendChild(optInicio);

          if (data.error) {
            const optErr = document.createElement('option');
            optErr.value = '';
            optErr.disabled = true;
            optErr.textContent = 'Error al cargar asientos';
            asientoSelect.appendChild(optErr);
            console.error(data.error);
            return;
          }

          const libres = data.asientos_libres || [];
          if (libres.length === 0) {
            const optNo = document.createElement('option');
            optNo.value = '';
            optNo.disabled = true;
            optNo.textContent = 'No hay asientos disponibles';
            asientoSelect.appendChild(optNo);
            return;
          }

          libres.forEach(function (num) {
            const opt = document.createElement('option');
            opt.value = num;
            opt.textContent = num;
            asientoSelect.appendChild(opt);
          });
        })
        .catch(function (err) {
          console.error('Error fetch asientos:', err);
          asientoSelect.innerHTML = '';
          const optErr = document.createElement('option');
          optErr.value = '';
          optErr.disabled = true;
          optErr.textContent = 'Error al cargar asientos';
          asientoSelect.appendChild(optErr);
        });
    });
  }

  // 3) Mostrar/ocultar módulo tarjeta
  if (metodoPago && tarjetaModule) {
    metodoPago.addEventListener("change", function() {
      tarjetaModule.style.display = (metodoPago.value === "Tarjeta") ? "" : "none";
    });
  }

  // 4) Formateo dinámico número tarjeta
  if (cardNumberInput) {
    cardNumberInput.addEventListener("input", function (e) {
      let raw = e.target.value.replace(/\D/g, "");
      raw = raw.substring(0, 16);
      let formatted = raw.replace(/(.{4})/g, "$1-");
      if (formatted.endsWith("-")) {
        formatted = formatted.slice(0, -1);
      }
      e.target.value = formatted;
    });
  }

  // 5) Validación Bootstrap + validación tarjeta + JSON
  if (form) {
    form.addEventListener("submit", function(event) {

      // Validación HTML5 general
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
        form.classList.add('was-validated');
        return;
      }

      form.classList.add('was-validated');

      // Si el método es tarjeta, validaciones extra
      if (metodoPago && metodoPago.value === "Tarjeta") {

        var cardNum  = (cardNumberInput ? cardNumberInput.value : "").replace(/\D/g, "").trim();
        var cardMonth = (cardMonthInput ? cardMonthInput.value : "").trim();
        var cardYear  = (cardYearInput ? cardYearInput.value : "").trim();
        var cardCVV   = (cardCVVInput ? cardCVVInput.value : "").trim();
        var cardHolder = (cardHolderInput ? cardHolderInput.value : "").trim();

        // Guardar MM/AA en hidden
        var expiraInput = document.getElementById("tarjeta_expira");
        if (expiraInput) {
          expiraInput.value = cardMonth + "/" + cardYear;
        }

        // Validaciones básicas
        if (cardNum.length !== 16 || isNaN(cardNum)) {
          alert("Número de tarjeta inválido (16 dígitos numéricos).");
          event.preventDefault();
          event.stopPropagation();
          return;
        }

        var mes = parseInt(cardMonth, 10);
        if (isNaN(mes) || mes < 1 || mes > 12) {
          alert("Mes de expiración inválido.");
          event.preventDefault();
          event.stopPropagation();
          return;
        }

        if (cardCVV.length < 3 || cardCVV.length > 4 || isNaN(cardCVV)) {
          alert("CVV inválido.");
          event.preventDefault();
          event.stopPropagation();
          return;
        }

        // Dejar número limpio en el input para el backend
        if (cardNumberInput) {
          cardNumberInput.value = cardNum;
        }

        // Crear JSON simulado
        var pagoJSON = {
          metodo: "tarjeta",
          tarjeta: {
            numero: cardNum,
            mes: cardMonth,
            anio: cardYear,
            cvv: cardCVV,
            titular: cardHolder
          },
          timestamp: new Date().toISOString()
        };

        console.log("JSON enviado al sistema externo:", pagoJSON);

        // Enviar al backend en hidden input
        var hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "pago_json";
        hidden.value = JSON.stringify(pagoJSON);
        form.appendChild(hidden);
      }
    });
  }

});
</script>

{% endblock %}
