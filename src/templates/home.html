{% extends "./layout.html" %}
{% block title %}Taquilla - Home{% endblock %}

{% block body %}
<div class="container py-4">
  {# Mensajes flash (ej. venta registrada, errores, etc.) #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'warning' if category == 'message' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# Encabezado #}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">Panel de taquilla</h1>
      <p class="mb-0 text-muted">
        Bienvenido, <strong>{{ current_user.nombre_completo }}</strong>
        <span class="text-secondary">({{ current_user.rol }})</span>
      </p>
    </div>
    <div class="text-end">
      <small class="text-muted d-block">
        Hoy: {{ fecha_hoy|default('Fecha del día') }}
      </small>

      <form method="POST" action="{{ url_for('logout') }}" class="mt-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-outline-danger btn-sm">
          Cerrar sesión
        </button>
      </form>
    </div>
  </div>

  {# KPIs del día #}
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Boletos vendidos hoy</h6>
          <h3 class="card-title mb-0">
            {{ boletos_hoy|default(0) }}
          </h3>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Monto total del día</h6>
          <h3 class="card-title mb-0">
            ${{ monto_hoy|default("0.00") }} MXN
          </h3>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Viajes programados hoy</h6>
          <h3 class="card-title mb-0">
            {{ viajes_hoy_count|default(0) }}
          </h3>
        </div>
      </div>
    </div>
  </div>

  {# Acciones principales #}
  <div class="row g-3 mb-4">
    <div class="col-md-{% if current_user.rol == 'Admin' %}3{% elif current_user.rol == 'Chofer' %}4{% else %}4{% endif %}">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Nueva venta</h5>
          <p class="card-text text-muted flex-grow-1">
            Registrar un nuevo boleto para un pasajero en un viaje programado.
          </p>
          <a href="{{ url_for('nueva_venta') }}" class="btn btn-primary mt-auto">Ir a nueva venta</a>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Viajes próximos</h5>
          <p class="card-text text-muted flex-grow-1">
            Ver todos los viajes programados para los próximos días.
          </p>
          <a href="{{ url_for('viajes_proximos') }}" class="btn btn-outline-primary mt-auto">
            Ver viajes próximos
          </a>
        </div>
      </div>
    </div>

    <div class="col-md-{% if current_user.rol == 'Admin' %}3{% elif current_user.rol == 'Chofer' %}4{% else %}4{% endif %}">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Ventas del día</h5>
          <p class="card-text text-muted flex-grow-1">
            Consultar las ventas realizadas hoy por usuario.
          </p>
          <a href="{{ url_for('ventas_hoy') }}" class="btn btn-primary mt-auto">
            <i class="bi bi-cash-coin"></i> Ver ventas del día
          </a>
        </div>
      </div>
    </div>
  </div>

  {# Tabla de viajes programados para hoy #}
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white">
      <h5 class="mb-0">Viajes programados para hoy</h5>
      <small class="text-muted">
        Selecciona un viaje para iniciar una venta rápida.
      </small>
    </div>

    {# Barra de filtros por estado #}
    <div class="border-top bg-light px-3 py-2">
      <strong>Filtrar por estado:</strong>
      <div class="btn-group btn-group-sm ms-2" role="group" aria-label="Filtro estado">
        <button type="button" class="btn btn-outline-secondary active" data-filtro-estado="todos">
          Todos
        </button>
        <button type="button" class="btn btn-outline-primary" data-filtro-estado="Programado">
          Programado
        </button>
        <button type="button" class="btn btn-outline-warning" data-filtro-estado="EnRuta">
          En ruta
        </button>
        <button type="button" class="btn btn-outline-success" data-filtro-estado="Finalizado">
          Finalizado
        </button>
        <button type="button" class="btn btn-outline-danger" data-filtro-estado="Cancelado">
          Cancelado
        </button>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
          <tr>
            <th scope="col">Salida</th>
            <th scope="col">Llegada</th>
            <th scope="col">Origen</th>
            <th scope="col">Destino</th>
            <th scope="col">Ruta / Clase</th>
            <th scope="col">Chofer</th>
            <th scope="col">Autobús</th>
            <th scope="col" class="text-center">Asientos disp.</th>
            <th scope="col" class="text-center">Estado</th>
          </tr>
          </thead>
          <tbody>
          {% if viajes_hoy %}
            {% for v in viajes_hoy %}
              {# Tomamos estado_actual si existe, en otro caso el campo estado #}
              {% set estado_raw = v.estado_actual if v.estado_actual is defined else v.estado %}
              <tr data-estado="{{ estado_raw }}">
                <td>{{ v.fecha_salida }}</td>
                <td>{{ v.fecha_llegada }}</td>
                <td>{{ v.origen_ciudad }} - {{ v.origen_terminal }}</td>
                <td>{{ v.destino_ciudad }} - {{ v.destino_terminal }}</td>
                <td>{{ v.ruta_nombre }} / {{ v.clase_nombre }}</td>
                <td>{{ v.chofer_nombre }}</td>
                <td>{{ v.autobus_identificador }}</td>
                <td class="text-center">{{ v.asientos_disponibles }}</td>

                <td class="text-center">
                  {% if estado_raw == 'Cancelado' %}
                    <span class="badge bg-danger">
                      <i class="bi bi-x-circle"></i> Cancelado
                    </span>
                  {% elif estado_raw == 'Programado' %}
                    <span class="badge bg-primary">
                      <i class="bi bi-calendar-check"></i> Programado
                    </span>
                  {% elif estado_raw == 'EnRuta' %}
                    <span class="badge bg-warning text-dark">
                      <i class="bi bi-truck"></i> En ruta
                    </span>
                  {% elif estado_raw == 'Finalizado' %}
                    <span class="badge bg-success">
                      <i class="bi bi-check-circle"></i> Finalizado
                    </span>
                  {% else %}
                    <span class="badge bg-secondary">Desconocido</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                No hay viajes programados para hoy.
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{# JS para filtros de estado #}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const botones = document.querySelectorAll('[data-filtro-estado]');
  const filas   = document.querySelectorAll('table tbody tr');

  botones.forEach(btn => {
    btn.addEventListener('click', function () {
      const filtro = this.getAttribute('data-filtro-estado');

      // Cambiar botón activo
      botones.forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      // Mostrar/ocultar filas según estado
      filas.forEach(tr => {
        const estado = tr.getAttribute('data-estado');
        if (!estado) return;

        if (filtro === 'todos' || estado === filtro) {
          tr.classList.remove('d-none');
        } else {
          tr.classList.add('d-none');
        }
      });
    });
  });
});
</script>

{% endblock %}
